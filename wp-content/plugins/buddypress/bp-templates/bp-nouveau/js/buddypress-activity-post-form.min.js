window.wp=window.wp||{},window.bp=window.bp||{},function(e,t){bp.Nouveau=bp.Nouveau||{},void 0!==bp.Nouveau.Activity&&"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau.Activity.postForm={start:function(){this.views=new Backbone.Collection,this.ActivityObjects=new bp.Collections.ActivityObjects,this.buttons=new Backbone.Collection,this.postFormView()},postFormView:function(){if(t("#bp-nouveau-activity-form").length){var e=new bp.Views.PostForm;this.views.add({id:"post_form",view:e}),e.inject("#bp-nouveau-activity-form")}}},void 0===bp.View&&(bp.View=bp.Backbone.View.extend({inject:function(e){this.render(),t(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}})),bp.Models.Activity=Backbone.Model.extend({defaults:{user_id:0,item_id:0,object:"",content:""}}),bp.Models.ActivityObject=Backbone.Model.extend({defaults:{id:0,name:"",avatar_url:"",object_type:"group"}}),bp.Collections.ActivityObjects=Backbone.Collection.extend({model:bp.Models.ActivityObject,sync:function(e,t,i){if("read"===e)return i=i||{},i.context=this,i.data=_.extend(i.data||{},{action:"bp_nouveau_get_activity_objects"}),bp.ajax.send(i)},parse:function(e){return _.isArray(e)||(e=[e]),e}}),bp.Views.activityFeedback=bp.View.extend({tagName:"div",id:"message",template:bp.template("activity-post-form-feedback"),initialize:function(){this.model=new Backbone.Model,this.options.value&&this.model.set("message",this.options.value,{silent:!0}),this.type="info",_.isUndefined(this.options.type)||"info"===this.options.type||(this.type=this.options.type),this.el.className="bp-messages bp-feedback "+this.type}}),bp.Views.ActivityInput=bp.View.extend({tagName:"input",attributes:{type:"text"},initialize:function(){_.isObject(this.options)&&_.each(this.options,function(e,t){this.$el.prop(t,e)},this)}}),bp.Views.WhatsNew=bp.View.extend({tagName:"textarea",className:"bp-suggestions",id:"whats-new",attributes:{name:"whats-new",cols:"50",rows:"4",placeholder:BP_Nouveau.activity.strings.whatsnewPlaceholder,"aria-label":BP_Nouveau.activity.strings.whatsnewLabel},initialize:function(){this.on("ready",this.adjustContent,this),this.options.activity.on("change:content",this.resetContent,this)},adjustContent:function(){this.$el.css({resize:"none",height:"50px"});var e=bp.Nouveau.getLinkParams(null,"r")||null;_.isNull(e)||(this.$el.text("@"+_.escape(e)+" "),this.$el.focus())},resetContent:function(e){_.isUndefined(e)||this.$el.val(e.get("content"))}}),bp.Views.WhatsNewPostIn=bp.View.extend({tagName:"select",id:"whats-new-post-in",attributes:{name:"whats-new-post-in","aria-label":BP_Nouveau.activity.strings.whatsnewpostinLabel},events:{change:"change"},keys:[],initialize:function(){this.model=new Backbone.Model,this.filters=this.options.filters||{},this.$el.html(_.chain(this.filters).map(function(e,i){return{el:t("<option></option>").val(i).html(e.text)[0],priority:e.priority||50}},this).sortBy("priority").pluck("el").value())},change:function(){var e=this.filters[this.el.value];e&&this.model.set({selected:this.el.value,placeholder:e.autocomplete_placeholder})}}),bp.Views.Item=bp.View.extend({tagName:"li",className:"bp-activity-object",template:bp.template("activity-target-item"),attributes:{role:"checkbox"},initialize:function(){this.model.get("selected")&&(this.el.className+=" selected")},events:{click:"setObject"},setObject:function(e){e.preventDefault(),!0===this.model.get("selected")?this.model.clear():this.model.set("selected",!0)}}),bp.Views.AutoComplete=bp.View.extend({tagName:"ul",id:"whats-new-post-in-box-items",events:{keyup:"autoComplete"},initialize:function(){var e=new bp.Views.ActivityInput({type:"text",id:"activity-autocomplete",placeholder:this.options.placeholder||""}).render();this.$el.prepend(t("<li></li>").html(e.$el)),this.on("ready",this.setFocus,this),this.collection.on("add",this.addItemView,this),this.collection.on("reset",this.cleanView,this)},setFocus:function(){this.$el.find("#activity-autocomplete").focus()},addItemView:function(e){this.views.add(new bp.Views.Item({model:e}))},autoComplete:function(){var e=t("#activity-autocomplete").val();this.collection.reset(),2>e.length||this.collection.fetch({data:{type:this.options.type,search:e,nonce:BP_Nouveau.nonces.activity},success:_.bind(this.itemFetched,this),error:_.bind(this.itemFetched,this)})},itemFetched:function(e){e.length||this.cleanView()},cleanView:function(){_.each(this.views._views[""],function(e){e.remove()})}}),bp.Views.FormAvatar=bp.View.extend({tagName:"div",id:"whats-new-avatar",template:bp.template("activity-post-form-avatar"),initialize:function(){this.model=new Backbone.Model(_.pick(BP_Nouveau.activity.params,["user_id","avatar_url","avatar_width","avatar_height","avatar_alt","user_domain"])),this.model.has("avatar_url")&&this.model.set("display_avatar",!0)}}),bp.Views.FormContent=bp.View.extend({tagName:"div",id:"whats-new-content",initialize:function(){this.$el.html(t("<div></div>").prop("id","whats-new-textarea")),this.views.set("#whats-new-textarea",new bp.Views.WhatsNew({activity:this.options.activity}))}}),bp.Views.FormOptions=bp.View.extend({tagName:"div",id:"whats-new-options",template:bp.template("activity-post-form-options")}),bp.Views.BeforeFormInputs=bp.View.extend({tagName:"div",template:bp.template("activity-before-post-form-inputs")}),bp.Views.FormTarget=bp.View.extend({tagName:"div",id:"whats-new-post-in-box",className:"in-profile",initialize:function(){var e=new bp.Views.WhatsNewPostIn({filters:BP_Nouveau.activity.params.objects});this.views.add(e),e.model.on("change",this.attachAutocomplete,this),bp.Nouveau.Activity.postForm.ActivityObjects.on("change:selected",this.postIn,this)},attachAutocomplete:function(e){0!==bp.Nouveau.Activity.postForm.ActivityObjects.models.length&&bp.Nouveau.Activity.postForm.ActivityObjects.reset(),_.each(this.views._views[""],function(e){_.isUndefined(e.collection)||e.remove()}),"profile"!==e.get("selected")?(this.views.add(new bp.Views.AutoComplete({collection:bp.Nouveau.Activity.postForm.ActivityObjects,type:e.get("selected"),placeholder:e.get("placeholder")})),this.model.set("object",e.get("selected"))):this.model.set({object:"user",item_id:0}),this.updateDisplay()},postIn:function(e){if(_.isUndefined(e.get("id")))return this.model.set("item_id",0),void this.attachAutocomplete(new Backbone.Model({selected:this.model.get("object")}));this.model.set("item_id",e.get("id")),this.views.set("#whats-new-post-in-box-items",new bp.Views.Item({model:e}))},updateDisplay:function(){"user"!==this.model.get("object")?this.$el.removeClass():this.$el.hasClass("in-profile")||this.$el.addClass("in-profile")}}),bp.Views.FormButtons=bp.View.extend({tagName:"div",id:"whats-new-actions",initialize:function(){this.views.add(new bp.View({tagName:"ul",id:"whats-new-buttons"})),_.each(this.collection.models,function(e){this.addItemView(e)},this),this.collection.on("change:active",this.isActive,this)},addItemView:function(e){this.views.add("#whats-new-buttons",new bp.Views.FormButton({model:e}))},isActive:function(e){_.each(this.views._views[""],function(e,t){0!==t&&e.remove()}),!0===e.get("active")?(_.each(this.views._views["#whats-new-buttons"],function(t){t.model.get("id")!==e.get("id")&&(t.model.set("active",!1,{silent:!0}),t.$el.removeClass("active"),this.collection.trigger("reset:"+t.model.get("id"),this.model))},this),this.collection.trigger("display:"+e.get("id"),this)):this.collection.trigger("reset:"+e.get("id"),this.model)}}),bp.Views.FormButton=bp.View.extend({tagName:"li",className:"whats-new-button",template:bp.template("activity-post-form-buttons"),events:{click:"setActive"},setActive:function(e){var t=this.model.get("active")||!1;e.preventDefault(),!1===t?(this.$el.addClass("active"),this.model.set("active",!0)):(this.$el.removeClass("active"),this.model.set("active",!1))}}),bp.Views.FormSubmit=bp.View.extend({tagName:"div",id:"whats-new-submit",className:"in-profile",initialize:function(){var e=new bp.Views.ActivityInput({type:"reset",id:"aw-whats-new-reset",className:"text-button small",value:BP_Nouveau.activity.strings.cancelButton}),t=new bp.Views.ActivityInput({type:"submit",id:"aw-whats-new-submit",className:"button",name:"aw-whats-new-submit",value:BP_Nouveau.activity.strings.postUpdateButton});this.views.set([t,e]),this.model.on("change:object",this.updateDisplay,this)},updateDisplay:function(e){_.isUndefined(e)||("user"!==e.get("object")?this.$el.removeClass("in-profile"):this.$el.hasClass("in-profile")||this.$el.addClass("in-profile"))}}),bp.Views.PostForm=bp.View.extend({tagName:"form",className:"activity-form",id:"whats-new-form",attributes:{name:"whats-new-form",method:"post"},events:{"focus #whats-new":"displayFull",reset:"resetForm",submit:"postUpdate",keydown:"postUpdate"},initialize:function(){this.model=new bp.Models.Activity(_.pick(BP_Nouveau.activity.params,["user_id","item_id","object"])),this.options.backcompat=BP_Nouveau.activity.params.backcompat;var e=[new bp.Views.FormAvatar,new bp.Views.FormContent({activity:this.model})];!0===this.options.backcompat.before_post_form&&e.unshift(new bp.Views.BeforeFormInputs),this.resetModel=this.model.clone(),this.views.set(e),this.model.on("change:errors",this.displayFeedback,this)},displayFull:function(e){var i=!0===this.options.backcompat.before_post_form?3:2;this.cleanFeedback(),i===this.views._views[""].length&&(t(e.target).css({resize:"vertical",height:"auto"}),this.$el.addClass("activity-form-expanded"),!0===this.options.backcompat.post_form_options?this.views.add(new bp.Views.FormOptions({model:this.model})):this.views.add(new bp.View({id:"whats-new-options"})),_.isUndefined(BP_Nouveau.activity.params.buttons)||(bp.Nouveau.Activity.postForm.buttons.set(BP_Nouveau.activity.params.buttons),this.views.add("#whats-new-options",new bp.Views.FormButtons({collection:bp.Nouveau.Activity.postForm.buttons,model:this.model}))),!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length&&this.views.add("#whats-new-options",new bp.Views.FormTarget({model:this.model})),this.views.add("#whats-new-options",new bp.Views.FormSubmit({model:this.model})))},resetForm:function(){var e=this.options.backcompat.before_post_form?2:1;_.each(this.views._views[""],function(t,i){i>e&&t.remove()}),t("#whats-new").css({resize:"none",height:"50px"}),this.$el.removeClass("activity-form-expanded"),this.model.clear(),this.model.set(this.resetModel.attributes)},cleanFeedback:function(){_.each(this.views._views[""],function(e){"message"===e.$el.prop("id")&&e.remove()})},displayFeedback:function(e){_.isUndefined(this.model.get("errors"))?this.cleanFeedback():this.views.add(new bp.Views.activityFeedback(e.get("errors")))},postUpdate:function(e){var i=this,s={};if(e){if("keydown"===e.type&&(13!==e.keyCode||!e.ctrlKey))return e;e.preventDefault()}_.each(this.$el.serializeArray(),function(e){e.name=e.name.replace("[]",""),"whats-new"===e.name?i.model.set("content",e.value):-1===_.indexOf(["aw-whats-new-submit","whats-new-post-in"],e.name)&&(_.isUndefined(s[e.name])?s[e.name]=e.value:(_.isArray(s[e.name])||(s[e.name]=[s[e.name]]),s[e.name].push(e.value)))}),this.model.set(s,{silent:!0});var a={_wpnonce_post_update:BP_Nouveau.activity.params.post_nonce};t("#_bp_as_nonce").val()&&(a._bp_as_nonce=t("#_bp_as_nonce").val()),bp.ajax.post("post_update",_.extend(a,this.model.attributes)).done(function(e){var s=bp.Nouveau.getStorage("bp-activity"),a=t('[data-bp-search="activity"] input[type="search"]').val(),o={},n=!1;a&&(a=new RegExp(a,"im"),o=e.activity.match(a)),a&&!o||(n=!s.filter||0===parseInt(s.filter,10)||"activity_update"===s.filter),n&&e.is_directory&&(n="all"===s.scope&&("user"===i.model.get("object")||!1===e.is_private)||i.model.get("object")+"s"===s.scope),i.resetForm(),n?t("#activity-"+e.id).length||(t("#activity-stream ul.activity-list").length||t("#activity-stream").html(t("<ul></ul>").addClass("activity-list item-list bp-list")),bp.Nouveau.inject("#activity-stream ul.activity-list",e.activity,"prepend")):i.views.add(new bp.Views.activityFeedback({value:e.message,type:"updated"}))}).fail(function(e){i.model.set("errors",{type:"error",value:e.message})})}}),bp.Nouveau.Activity.postForm.start())}(bp,jQuery);