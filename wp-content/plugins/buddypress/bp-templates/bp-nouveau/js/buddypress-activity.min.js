window.bp=window.bp||{},function(t,a){"undefined"!=typeof BP_Nouveau&&(bp.Nouveau=bp.Nouveau||{},bp.Nouveau.Activity={start:function(){this.setupGlobals(),this.addListeners()},setupGlobals:function(){this.just_posted=[],this.current_page=1,this.mentions_count=Number(a(bp.Nouveau.objectNavParent+' [data-bp-scope="mentions"]').find("a span").html())||0,this.heartbeat_data={newest:"",highlights:{},last_recorded:0,first_recorded:0,document_title:a(document).prop("title")}},addListeners:function(){a("#buddypress").on("bp_heartbeat_send",this.heartbeatSend.bind(this)),a("#buddypress").on("bp_heartbeat_tick",this.heartbeatTick.bind(this)),a('#buddypress [data-bp-list="activity"]').on("click","li.load-newest, li.load-more",this.injectActivities.bind(this)),a("#buddypress").on("bp_ajax_request",'[data-bp-list="activity"]',this.scopeLoaded.bind(this)),a('#buddypress [data-bp-list="activity"]').on("bp_ajax_append",this.hideComments),a('#buddypress [data-bp-list="activity"]').on("click",".show-all",this.showComments),a('#buddypress [data-bp-list="activity"]').on("click",".activity-item",bp.Nouveau,this.activityActions),a(document).keydown(this.commentFormAction)},heartbeatSend:function(t,e){this.heartbeat_data.first_recorded=a("#buddypress [data-bp-list] [data-bp-activity-id]").first().data("bp-timestamp")||0,(0===this.heartbeat_data.last_recorded||this.heartbeat_data.first_recorded>this.heartbeat_data.last_recorded)&&(this.heartbeat_data.last_recorded=this.heartbeat_data.first_recorded),e.bp_activity_last_recorded=this.heartbeat_data.last_recorded,a("#buddypress .dir-search input[type=search]").length&&(e.bp_activity_last_recorded_search_terms=a("#buddypress .dir-search input[type=search]").val()),a.extend(e,{bp_heartbeat:bp.Nouveau.getStorage("bp-activity")})},heartbeatTick:function(t,e){var i,s,n=bp.Nouveau.objects,d=bp.Nouveau.getStorage("bp-activity","scope"),o=this;if(void 0!==e&&e.bp_activity_newest_activities){if(this.heartbeat_data.newest=a.trim(e.bp_activity_newest_activities.activities)+this.heartbeat_data.newest,this.heartbeat_data.last_recorded=Number(e.bp_activity_newest_activities.last_recorded),s=a(this.heartbeat_data.newest).filter(".activity-item"),i=Number(s.length),n.push("mentions"),"all"===d){a.each(s,function(t,e){e=a(e),a.each(n,function(t,i){-1!==a.inArray("bp-my-"+i,e.get(0).classList)&&(void 0===o.heartbeat_data.highlights[i]?o.heartbeat_data.highlights[i]=[e.data("bp-activity-id")]:-1===a.inArray(e.data("bp-activity-id"),o.heartbeat_data.highlights[i])&&o.heartbeat_data.highlights[i].push(e.data("bp-activity-id")))})});var r=new RegExp("bp-my-("+n.join("|")+")","g");this.heartbeat_data.newest=this.heartbeat_data.newest.replace(r,""),a(bp.Nouveau.objectNavParent+' [data-bp-scope="all"]').find("a span").html(i)}else this.heartbeat_data.highlights[d]=[],a.each(s,function(t,e){o.heartbeat_data.highlights[d].push(a(e).data("bp-activity-id"))});if(a.each(n,function(t,e){if(void 0!==o.heartbeat_data.highlights[e]&&o.heartbeat_data.highlights[e].length){var i=0;"mentions"===e&&(i=o.mentions_count),a(bp.Nouveau.objectNavParent+' [data-bp-scope="'+e+'"]').find("a span").html(Number(o.heartbeat_data.highlights[e].length)+i)}}),n.pop(),a(document).prop("title","("+i+") "+this.heartbeat_data.document_title),a('#buddypress [data-bp-list="activity"] li').first().hasClass("load-newest")){var c=a('#buddypress [data-bp-list="activity"] .load-newest a').html();a('#buddypress [data-bp-list="activity"] .load-newest a').html(c.replace(/([0-9]+)/,i))}else a('#buddypress [data-bp-list="activity"] ul.activity-list').prepend('<li class="load-newest"><a href="#newest">'+BP_Nouveau.newest+" ("+i+")</a></li>");a('#buddypress [data-bp-list="activity"]').trigger("bp_heartbeat_pending",this.heartbeat_data)}},injectActivities:function(t){var e=bp.Nouveau.getStorage("bp-activity"),i=e.scope||null,s=e.filter||null;if(a(t.currentTarget).hasClass("load-newest")){t.preventDefault(),a(t.currentTarget).remove();var n=a.parseHTML(this.heartbeat_data.newest);a.each(n,function(t,e){"LI"===e.nodeName&&a(e).hasClass("just-posted")&&a("#"+a(e).prop("id")).length&&a("#"+a(e).prop("id")).remove()}),a(t.delegateTarget).find(".activity-list").prepend(this.heartbeat_data.newest).trigger("bp_heartbeat_prepend",this.heartbeat_data),this.heartbeat_data.newest="","all"===i&&a(bp.Nouveau.objectNavParent+' [data-bp-scope="all"]').find("a span").html(""),"mentions"===i&&(bp.Nouveau.ajax({action:"activity_clear_new_mentions"},"activity"),this.mentions_count=0),a(bp.Nouveau.objectNavParent+' [data-bp-scope="'+i+'"]').find("a span").html(""),void 0!==this.heartbeat_data.highlights[i]&&(this.heartbeat_data.highlights[i]=[]),setTimeout(function(){a(t.delegateTarget).find("[data-bp-activity-id]").removeClass("newest_"+i+"_activity")},3e3),a(document).prop("title",this.heartbeat_data.document_title)}else if(a(t.currentTarget).hasClass("load-more")){var d=1*Number(this.current_page)+1,o=this,r="";t.preventDefault(),a(t.currentTarget).find("a").first().addClass("loading"),this.just_posted=[],a(t.delegateTarget).children(".just-posted").each(function(){o.just_posted.push(a(this).data("bp-activity-id"))}),a("#buddypress .dir-search input[type=search]").length&&(r=a("#buddypress .dir-search input[type=search]").val()),bp.Nouveau.objectRequest({object:"activity",scope:i,filter:s,search_terms:r,page:d,method:"append",exclude_just_posted:this.just_posted.join(","),target:"#buddypress [data-bp-list] ul.bp-list"}).done(function(e){!0===e.success&&(a(t.currentTarget).remove(),o.current_page=d)})}},hideComments:function(t){var e,i,s,n,d=a(t.target).find(".activity-comments");d.length&&d.each(function(t,d){n=a(d).children("ul"),(i=a(n).find("li")).length&&(e=a(d).closest(".activity-item"),s=a("#acomment-comment-"+e.data("bp-activity-id")+" span.comment-count").html()||" ",i.each(function(t,n){t<i.length-5&&(a(n).addClass("bp-hidden").hide(),t||a(n).before('<li class="show-all"><button class="text-button" type="button" data-bp-show-comments-id="#'+e.prop("id")+'/show-all/"><span class="icon dashicons dashicons-visibility" aria-hidden="true"></span> '+BP_Nouveau.show_x_comments.replace("%d",s)+"</button></li>"))}),a(n).children(".bp-hidden").length===a(n).children("li").length-1&&a(n).find("li.show-all").length&&a(n).children("li").removeClass("bp-hidden").toggle())})},showComments:function(t){t.preventDefault(),a(t.target).addClass("loading"),setTimeout(function(){a(t.target).closest("ul").find("li").removeClass("bp-hidden").fadeIn(300,function(){a(t.target).parent("li").remove()})},600)},scopeLoaded:function(t,e){this.hideComments(t),this.current_page=1,"mentions"===e.scope&&void 0!==e.response.new_mentions?(a.each(e.response.new_mentions,function(t,e){a("#buddypress #activity-stream").find('[data-bp-activity-id="'+e+'"]').addClass("newest_mentions_activity")}),this.mentions_count=0):void 0!==this.heartbeat_data.highlights[e.scope]&&this.heartbeat_data.highlights[e.scope].length&&a.each(this.heartbeat_data.highlights[e.scope],function(t,i){a("#buddypress #activity-stream").find('[data-bp-activity-id="'+i+'"]').length&&a("#buddypress #activity-stream").find('[data-bp-activity-id="'+i+'"]').addClass("newest_"+e.scope+"_activity")}),this.heartbeat_data.newest="",a.each(a(bp.Nouveau.objectNavParent+" [data-bp-scope]").find("a span"),function(t,e){0===parseInt(a(e).html(),10)&&a(e).html("")}),void 0!==this.heartbeat_data.highlights[e.scope]&&(this.heartbeat_data.highlights[e.scope]=[]),a(document).prop("title",this.heartbeat_data.document_title),setTimeout(function(){a("#buddypress #activity-stream .activity-item").removeClass("newest_"+e.scope+"_activity")},3e3)},activityActions:function(t){var e,i,s=t.data,n=a(t.target),d=a(t.currentTarget),o=d.data("bp-activity-id"),r=a(t.delegateTarget);if(a(n).is("span")&&(n=a(n).closest("a")),n.hasClass("fav")||n.hasClass("unfav")){var c=n.hasClass("fav")?"fav":"unfav";t.preventDefault(),n.addClass("loading"),s.ajax({action:"activity_mark_"+c,id:o},"activity").done(function(t){if(n.removeClass("loading"),!1!==t.success)if(n.fadeOut(200,function(){a(this).find("span").first().length?a(this).find("span").first().html(t.data.content):a(this).html(t.data.content),a(this).prop("title",t.data.content),"false"===a(this).attr("aria-pressed")?a(this).attr("aria-pressed","true"):a(this).attr("aria-pressed","false"),a(this).fadeIn(200)}),"fav"===c)void 0!==t.data.directory_tab&&(a(s.objectNavParent+' [data-bp-scope="favorites"]').length||a(s.objectNavParent+' [data-bp-scope="all"]').after(t.data.directory_tab)),n.removeClass("fav"),n.addClass("unfav");else if("unfav"===c){var e=a('[data-bp-user-scope="favorites"]').hasClass("selected")||a(s.objectNavParent+' [data-bp-scope="favorites"]').hasClass("selected");e&&d.remove(),void 0!==t.data.no_favorite&&(a(s.objectNavParent+' [data-bp-scope="all"]').length&&a(s.objectNavParent+' [data-bp-scope="all"]').hasClass("selected")?a(s.objectNavParent+' [data-bp-scope="favorites"]').remove():e&&r.append(t.data.no_favorite)),n.removeClass("unfav"),n.addClass("fav")}})}if(n.hasClass("delete-activity")||n.hasClass("acomment-delete")||n.hasClass("spam-activity")||n.hasClass("spam-activity-comment")){var l,p,h,b,m=n.closest("[data-bp-activity-comment-id]"),u=m.data("bp-activity-comment-id"),v=0;if(t.preventDefault(),void 0!==BP_Nouveau.confirm&&!1===window.confirm(BP_Nouveau.confirm))return!1;n.addClass("loading");var _={action:"delete_activity",id:o,_wpnonce:s.getLinkParams(n.prop("href"),"_wpnonce"),is_single:n.closest("[data-bp-single]").length};(n.hasClass("spam-activity")||n.hasClass("spam-activity-comment"))&&(_.action="bp_spam_activity"),l=d,u&&(delete _.is_single,_.id=u,_.is_comment=!0,l=m),s.ajax(_,"activity").done(function(t){if(n.removeClass("loading"),!1===t.success)l.prepend(t.data.feedback),l.find(".bp-feedback").hide().fadeIn(300);else{if(t.data.redirect)return window.location.href=t.data.redirect;u&&(v=1,d.append(m.find("form")),a.each(m.find("li"),function(){v+=1}),p=d.find(".acomment-reply span.comment-count"),h=Number(p.html()-v),p.html(h),(b=d.find("li.show-all a")).length&&b.html(BP_Nouveau.show_x_comments.replace("%d",h)),0===h&&d.removeClass("has-comments")),l.slideUp(300,function(){l.remove()}),u||d.data("bp-timestamp")!==s.Activity.heartbeat_data.last_recorded||(s.Activity.heartbeat_data.newest="",s.Activity.heartbeat_data.last_recorded=0)}})}if(n.closest("span").hasClass("activity-read-more")){var f=n.closest("div"),y=n.closest("span");if(e=null,a(f).hasClass("activity-inner")?e=o:a(f).hasClass("acomment-content")&&(e=n.closest("li").data("bp-activity-comment-id")),!e)return t;t.preventDefault(),a(y).addClass("loading"),s.ajax({action:"get_single_activity_content",id:e},"activity").done(function(t){a(y).removeClass("loading"),f.parent().find(".bp-feedback").length&&f.parent().find(".bp-feedback").remove(),!1===t.success?(f.after(t.data.feedback),f.parent().find(".bp-feedback").hide().fadeIn(300)):a(f).slideUp(300).html(t.data.contents).slideDown(300)})}if(n.hasClass("acomment-reply")||n.parent().hasClass("acomment-reply")){i=a("#ac-form-"+o),e=o,t.preventDefault(),n.parent().hasClass("acomment-reply")&&n.parent(),n.closest("li").data("bp-activity-comment-id")&&(e=n.closest("li").data("bp-activity-comment-id")),i.removeClass("root"),a(".ac-form").hide(),a.each(i.children("div"),function(t,e){a(e).hasClass("error")&&a(e).remove()}),e===o?(a('[data-bp-activity-id="'+e+'"] .activity-comments').append(i),i.addClass("root")):a('[data-bp-activity-comment-id="'+e+'"]').append(i),i.slideDown(200),n.attr("aria-expanded","true"),a.scrollTo(i,500,{offset:-100,easing:"swing"}),a("#ac-form-"+o+" textarea").focus()}if(n.hasClass("ac-reply-cancel")&&(a(n).closest(".ac-form").slideUp(200),a(".acomment-reply").attr("aria-expanded","false"),t.preventDefault()),"ac_form_submit"===n.prop("name")){var g,w;i=n.closest("form"),e=o,t.preventDefault(),n.closest("li").data("bp-activity-comment-id")&&(e=n.closest("li").data("bp-activity-comment-id")),g=a(i).find("textarea").first(),n.addClass("loading").prop("disabled",!0),g.addClass("loading").prop("disabled",!0),w={action:"new_activity_comment",_wpnonce_new_activity_comment:a("#_wpnonce_new_activity_comment").val(),comment_id:e,form_id:o,content:g.val()},a("#_bp_as_nonce_"+o).val()&&(w["_bp_as_nonce_"+o]=a("#_bp_as_nonce_"+o).val()),s.ajax(w,"activity").done(function(t){if(n.removeClass("loading"),g.removeClass("loading"),a(".acomment-reply").attr("aria-expanded","false"),!1===t.success)i.append(a(t.data.feedback).hide().fadeIn(200));else{var e=i.parent(),s=a.trim(t.data.contents);i.fadeOut(200,function(){0===e.children("ul").length&&(e.hasClass("activity-comments")?e.prepend("<ul></ul>"):e.append("<ul></ul>")),e.children("ul").append(a(s).hide().fadeIn(200)),a(i).find("textarea").first().val(""),e.parent().addClass("has-comments")}),h=Number(a(d).find("a span.comment-count").html()||0)+1,a(d).find("a span.comment-count").html(h),(b=a(d).find(".show-all a"))&&b.html(BP_Nouveau.show_x_comments.replace("%d",h))}n.prop("disabled",!1),g.prop("disabled",!1)})}},commentFormAction:function(t){var e,i;return t=t||window.event,t.target?e=t.target:t.srcElement&&(e=t.srcElement),3===e.nodeType&&(e=e.parentNode),!0===t.altKey||!0===t.metaKey?t:"TEXTAREA"===e.tagName&&a(e).hasClass("ac-input")?void(27===(i=t.keyCode?t.keyCode:t.which)&&!1===t.ctrlKey?"TEXTAREA"===e.tagName&&a(e).closest("form").slideUp(200):t.ctrlKey&&13===i&&a(e).val()&&a(e).closest("form").find("[type=submit]").first().trigger("click")):t}},bp.Nouveau.Activity.start())}(bp,jQuery);