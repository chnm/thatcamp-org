!function(t,e){"function"==typeof define&&define.amd?define(["jquery"],function(i){return t.returnExportsGlobal=e(i)}):"object"==typeof exports?module.exports=e(require("jquery")):e(jQuery)}(this,function(t){var e,i,n,r,o,s,a,h=[].slice;i=function(){function e(e){this.current_flag=null,this.controllers={},this.alias_maps={},this.$inputor=t(e),this.setIframe(),this.listen()}return e.prototype.createContainer=function(e){if(0===(this.$el=t("#atwho-container",e)).length)return t(e.body).append(this.$el=t("<div id='atwho-container'></div>"))},e.prototype.setIframe=function(t,e){var i;return null==e&&(e=!1),t?(this.window=t.contentWindow,this.document=t.contentDocument||this.window.document,this.iframe=t):(this.document=document,this.window=window,this.iframe=null),(this.iframeStandalone=e)?(null!=(i=this.$el)&&i.remove(),this.createContainer(this.document)):this.createContainer(document)},e.prototype.controller=function(t){var e,i,n,r;if(this.alias_maps[t])i=this.controllers[this.alias_maps[t]];else{r=this.controllers;for(n in r)if(e=r[n],n===t){i=e;break}}return i||this.controllers[this.current_flag]},e.prototype.set_context_for=function(t){return this.current_flag=t,this},e.prototype.reg=function(t,e){var i,r;return i=(r=this.controllers)[t]||(r[t]=new n(this,t)),e.alias&&(this.alias_maps[e.alias]=t),i.init(e),this},e.prototype.listen=function(){return this.$inputor.on("keyup.atwhoInner",function(t){return function(e){return t.on_keyup(e)}}(this)).on("keydown.atwhoInner",function(t){return function(e){return t.on_keydown(e)}}(this)).on("scroll.atwhoInner",function(t){return function(e){var i;return null!=(i=t.controller())?i.view.hide(e):void 0}}(this)).on("blur.atwhoInner",function(t){return function(e){var i;if(i=t.controller())return i.view.hide(e,i.get_opt("display_timeout"))}}(this)).on("click.atwhoInner",function(t){return function(e){return t.dispatch()}}(this))},e.prototype.shutdown=function(){var t,e;e=this.controllers;for(t in e)e[t].destroy(),delete this.controllers[t];return this.$inputor.off(".atwhoInner"),this.$el.remove()},e.prototype.dispatch=function(){return t.map(this.controllers,function(t){return function(e){var i;return(i=e.get_opt("delay"))?(clearTimeout(t.delayedCallback),t.delayedCallback=setTimeout(function(){if(e.look_up())return t.set_context_for(e.at)},i)):e.look_up()?t.set_context_for(e.at):void 0}}(this))},e.prototype.on_keyup=function(e){var i;switch(e.keyCode){case o.ESC:e.preventDefault(),null!=(i=this.controller())&&i.view.hide();break;case o.DOWN:case o.UP:case o.CTRL:t.noop();break;case o.P:case o.N:e.ctrlKey||this.dispatch();break;default:this.dispatch()}},e.prototype.on_keydown=function(e){var i,n;if((i=null!=(n=this.controller())?n.view:void 0)&&i.visible())switch(e.keyCode){case o.ESC:e.preventDefault(),i.hide(e);break;case o.UP:e.preventDefault(),i.prev();break;case o.DOWN:e.preventDefault(),i.next();break;case o.P:if(!e.ctrlKey)return;e.preventDefault(),i.prev();break;case o.N:if(!e.ctrlKey)return;e.preventDefault(),i.next();break;case o.TAB:case o.ENTER:if(!i.visible())return;e.preventDefault(),i.choose(e);break;default:t.noop()}},e}(),n=function(){function e(e,i){this.app=e,this.at=i,this.$inputor=this.app.$inputor,this.id=this.$inputor[0].id||this.uid(),this.setting=null,this.query=null,this.pos=0,this.cur_rect=null,this.range=null,0===(this.$el=t("#atwho-ground-"+this.id,this.app.$el)).length&&this.app.$el.append(this.$el=t("<div id='atwho-ground-"+this.id+"'></div>")),this.model=new s(this),this.view=new a(this)}return e.prototype.uid=function(){return(Math.random().toString(16)+"000000000").substr(2,8)+(new Date).getTime()},e.prototype.init=function(e){return this.setting=t.extend({},this.setting||t.fn.atwho.default,e),this.view.init(),this.model.reload(this.setting.data)},e.prototype.destroy=function(){return this.trigger("beforeDestroy"),this.model.destroy(),this.view.destroy(),this.$el.remove()},e.prototype.call_default=function(){var e,i,n;n=arguments[0],e=2<=arguments.length?h.call(arguments,1):[];try{return r[n].apply(this,e)}catch(e){return i=e,t.error(i+" Or maybe At.js doesn't have function "+n)}},e.prototype.trigger=function(t,e){var i,n;return null==e&&(e=[]),e.push(this),i=this.get_opt("alias"),n=i?t+"-"+i+".atwho":t+".atwho",this.$inputor.trigger(n,e)},e.prototype.callbacks=function(t){return this.get_opt("callbacks")[t]||r[t]},e.prototype.get_opt=function(t,e){try{return this.setting[t]}catch(t){return t,null}},e.prototype.content=function(){var t;if(this.$inputor.is("textarea, input"))return this.$inputor.val();if(t=this.mark_range())return(t.startContainer.textContent||"").slice(0,t.startOffset)},e.prototype.catch_query=function(){var t,e,i,n,r,o;return e=this.content(),t=this.$inputor.caret("pos",{iframe:this.app.iframe}),o=e.slice(0,t),n=this.callbacks("matcher").call(this,this.at,o,this.get_opt("start_with_space")),"string"==typeof n&&n.length<=this.get_opt("max_len",20)?(i=(r=t-n.length)+n.length,this.pos=r,n={text:n,head_pos:r,end_pos:i},this.trigger("matched",[this.at,n.text])):(n=null,this.view.hide()),this.query=n},e.prototype.rect=function(){var e,i,n;if(e=this.$inputor.caret("offset",this.pos-1,{iframe:this.app.iframe}))return this.app.iframe&&!this.app.iframeStandalone&&(i=t(this.app.iframe).offset(),e.left+=i.left,e.top+=i.top),this.$inputor.is("[contentEditable]")&&(e=this.cur_rect||(this.cur_rect=e)),n=this.app.document.selection?0:2,{left:e.left,top:e.top,bottom:e.top+e.height+n}},e.prototype.reset_rect=function(){if(this.$inputor.is("[contentEditable]"))return this.cur_rect=null},e.prototype.mark_range=function(){var t;if(this.$inputor.is("[contentEditable]"))return this.app.window.getSelection&&(t=this.app.window.getSelection()).rangeCount>0?this.range=t.getRangeAt(0):this.app.document.selection?this.ie8_range=this.app.document.selection.createRange():void 0},e.prototype.insert_content_for=function(e){var i,n,r;return n=e.data("value"),r=this.get_opt("insert_tpl"),this.$inputor.is("textarea, input")||!r?n:(i=t.extend({},e.data("item-data"),{"atwho-data-value":n,"atwho-at":this.at}),this.callbacks("tpl_eval").call(this,r,i))},e.prototype.insert=function(e,i){var n,r,o,s,a,h,l,u,c,p,f,d;if(n=this.$inputor,c=this.callbacks("inserting_wrapper").call(this,n,e,this.get_opt("suffix")),n.is("textarea, input"))u=""+(l=(h=n.val()).slice(0,Math.max(this.query.head_pos-this.at.length,0)))+c+h.slice(this.query.end_pos||0),n.val(u),n.caret("pos",l.length+c.length,{iframe:this.app.iframe});else if(s=this.range){for(o=s.startOffset-(this.query.end_pos-this.query.head_pos)-this.at.length,s.setStart(s.endContainer,Math.max(o,0)),s.setEnd(s.endContainer,s.endOffset),s.deleteContents(),p=0,f=(d=t(c,this.app.document)).length;p<f;p++)r=d[p],s.insertNode(r),s.setEndAfter(r),s.collapse(!1);(a=this.app.window.getSelection()).removeAllRanges(),a.addRange(s)}else(s=this.ie8_range)&&(s.moveStart("character",this.query.end_pos-this.query.head_pos-this.at.length),s.pasteHTML(c),s.collapse(!1),s.select());return n.is(":focus")||n.focus(),n.change()},e.prototype.render_view=function(t){var e;return e=this.get_opt("search_key"),t=this.callbacks("sorter").call(this,this.query.text,t.slice(0,1001),e),this.view.render(t.slice(0,this.get_opt("limit")))},e.prototype.look_up=function(){var e,i;if(e=this.catch_query())return i=function(t){return t&&t.length>0?this.render_view(t):this.view.hide()},this.model.query(e.text,t.proxy(i,this)),e},e}(),s=function(){function e(t){this.context=t,this.at=this.context.at,this.storage=this.context.$inputor}return e.prototype.destroy=function(){return this.storage.data(this.at,null)},e.prototype.saved=function(){return this.fetch()>0},e.prototype.query=function(t,e){var i,n,r;return i=this.fetch(),n=this.context.get_opt("search_key"),i=this.context.callbacks("filter").call(this.context,t,i,n)||[],r=this.context.callbacks("remote_filter"),i.length>0||!r&&0===i.length?e(i):r.call(this.context,t,e)},e.prototype.fetch=function(){return this.storage.data(this.at)||[]},e.prototype.save=function(t){return this.storage.data(this.at,this.context.callbacks("before_save").call(this.context,t||[]))},e.prototype.load=function(t){if(!this.saved()&&t)return this._load(t)},e.prototype.reload=function(t){return this._load(t)},e.prototype._load=function(e){return"string"==typeof e?t.ajax(e,{dataType:"json"}).done(function(t){return function(e){return t.save(e)}}(this)):this.save(e)},e}(),a=function(){function e(e){this.context=e,this.$el=t("<div class='atwho-view'><ul class='atwho-view-ul'></ul></div>"),this.timeout_id=null,this.context.$el.append(this.$el),this.bind_event()}return e.prototype.init=function(){var t;return t=this.context.get_opt("alias")||this.context.at.charCodeAt(0),this.$el.attr({id:"at-view-"+t})},e.prototype.destroy=function(){return this.$el.remove()},e.prototype.bind_event=function(){var e;return(e=this.$el.find("ul")).on("mouseenter.atwho-view","li",function(i){return e.find(".cur").removeClass("cur"),t(i.currentTarget).addClass("cur")}).on("click.atwho-view","li",function(i){return function(n){return e.find(".cur").removeClass("cur"),t(n.currentTarget).addClass("cur"),i.choose(n),n.preventDefault()}}(this))},e.prototype.visible=function(){return this.$el.is(":visible")},e.prototype.choose=function(t){var e,i;if((e=this.$el.find(".cur")).length&&(i=this.context.insert_content_for(e),this.context.insert(this.context.callbacks("before_insert").call(this.context,i,e),e),this.context.trigger("inserted",[e,t]),this.hide(t)),this.context.get_opt("hide_without_suffix"))return this.stop_showing=!0},e.prototype.reposition=function(e){var i,n,r,o;return o=this.context.app.iframeStandalone?this.context.app.window:window,e.bottom+this.$el.height()-t(o).scrollTop()>t(o).height()&&(e.bottom=e.top-this.$el.height()),e.left>(n=t(o).width()-this.$el.width()-5)&&(e.left=n),i={left:e.left,top:e.bottom},null!=(r=this.context.callbacks("before_reposition"))&&r.call(this.context,i),this.$el.offset(i),this.context.trigger("reposition",[i])},e.prototype.next=function(){var t,e;return t=this.$el.find(".cur").removeClass("cur"),(e=t.next()).length||(e=this.$el.find("li:first")),e.addClass("cur"),this.$el.animate({scrollTop:Math.max(0,t.innerHeight()*(e.index()+2)-this.$el.height())},150)},e.prototype.prev=function(){var t,e;return t=this.$el.find(".cur").removeClass("cur"),(e=t.prev()).length||(e=this.$el.find("li:last")),e.addClass("cur"),this.$el.animate({scrollTop:Math.max(0,t.innerHeight()*(e.index()+2)-this.$el.height())},150)},e.prototype.show=function(){var t;{if(!this.stop_showing)return this.context.mark_range(),this.visible()||(this.$el.show(),this.$el.scrollTop(0),this.context.trigger("shown")),(t=this.context.rect())?this.reposition(t):void 0;this.stop_showing=!1}},e.prototype.hide=function(t,e){var i;if(this.visible())return isNaN(e)?(this.context.reset_rect(),this.$el.hide(),this.context.trigger("hidden",[t])):(i=function(t){return function(){return t.hide()}}(this),clearTimeout(this.timeout_id),this.timeout_id=setTimeout(i,e))},e.prototype.render=function(e){var i,n,r,o,s,a,h;{if(t.isArray(e)&&e.length>0){for(this.$el.find("ul").empty(),n=this.$el.find("ul"),s=this.context.get_opt("tpl"),a=0,h=e.length;a<h;a++)r=e[a],r=t.extend({},r,{"atwho-at":this.context.at}),o=this.context.callbacks("tpl_eval").call(this.context,s,r),(i=t(this.context.callbacks("highlighter").call(this.context,o,this.context.query.text))).data("item-data",r),n.append(i);return this.show(),this.context.get_opt("highlight_first")?n.find("li:first").addClass("cur"):void 0}this.hide()}},e}(),o={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13,CTRL:17,P:80,N:78},r={before_save:function(e){var i,n,r,o;if(!t.isArray(e))return e;for(o=[],n=0,r=e.length;n<r;n++)i=e[n],t.isPlainObject(i)?o.push(i):o.push({name:i});return o},matcher:function(t,e,i){var n,r,o,s;return t=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),i&&(t="(?:^|\\s)"+t),o=decodeURI("%C3%80"),s=decodeURI("%C3%BF"),r=new RegExp(t+"([A-Za-z"+o+"-"+s+"0-9_+-]*)$|"+t+"([^\\x00-\\xff]*)$","gi"),n=r.exec(e),n?n[2]||n[1]:null},filter:function(t,e,i){var n,r,o,s;for(s=[],r=0,o=e.length;r<o;r++)n=e[r],~new String(n[i]).toLowerCase().indexOf(t.toLowerCase())&&s.push(n);return s},remote_filter:null,sorter:function(t,e,i){var n,r,o,s;if(!t)return e;for(s=[],r=0,o=e.length;r<o;r++)(n=e[r]).atwho_order=new String(n[i]).toLowerCase().indexOf(t.toLowerCase()),n.atwho_order>-1&&s.push(n);return s.sort(function(t,e){return t.atwho_order-e.atwho_order})},tpl_eval:function(t,e){try{return t.replace(/\$\{([^\}]*)\}/g,function(t,i,n){return e[i]})}catch(t){return t,""}},highlighter:function(t,e){var i;return e?(i=new RegExp(">\\s*(\\w*?)("+e.replace("+","\\+")+")(\\w*)\\s*<","ig"),t.replace(i,function(t,e,i,n){return"> "+e+"<strong>"+i+"</strong>"+n+" <"})):t},before_insert:function(t,e){return t},inserting_wrapper:function(t,e,i){var n;return i=""===i?i:i||" ",t.is("textarea, input")?""+e+i:"true"===t.attr("contentEditable")?(i=" "===i?"&nbsp;":i,n=/firefox/i.test(navigator.userAgent)?"<span>"+e+i+"</span>":"<span contenteditable='false'>"+e+(i="<span contenteditable='false'>"+i+"</span>")+"</span>",this.app.document.selection&&(n="<span contenteditable='true'>"+e+"</span>"),n+"<span></span>"):void 0}},e={load:function(t,e){var i;if(i=this.controller(t))return i.model.load(e)},setIframe:function(t,e){return this.setIframe(t,e),null},run:function(){return this.dispatch()},destroy:function(){return this.shutdown(),this.$inputor.data("atwho",null)}},t.fn.atwho=function(n){var r,o;return o=arguments,r=null,this.filter('textarea, input, [contenteditable=""], [contenteditable=true]').each(function(){var s,a;return(a=(s=t(this)).data("atwho"))||s.data("atwho",a=new i(this)),"object"!=typeof n&&n?e[n]&&a?r=e[n].apply(a,Array.prototype.slice.call(o,1)):t.error("Method "+n+" does not exist on jQuery.caret"):a.reg(n.at,n)}),r||this},t.fn.atwho.default={at:void 0,alias:void 0,data:null,tpl:"<li data-value='${atwho-at}${name}'>${name}</li>",insert_tpl:"<span id='${id}'>${atwho-data-value}</span>",callbacks:r,search_key:"name",suffix:void 0,hide_without_suffix:!1,start_with_space:!0,highlight_first:!0,limit:5,max_len:20,display_timeout:300,delay:null}});